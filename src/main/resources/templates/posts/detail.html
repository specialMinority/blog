<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${post.title}">投稿</title>
    <link rel="stylesheet" href="/responsive.css?v=9">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; max-width: 800px; margin: 2rem auto; padding: 20px; line-height: 1.6; color: #333; }
        h1 { font-size: 2rem; margin-bottom: 0.5rem; word-break: break-all; }
        .muted { color: #666; font-size: 0.9rem; margin-bottom: 2rem; border-bottom: 1px solid #eee; padding-bottom: 1rem; }
        pre { background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; font-family: inherit; font-size: 1rem; color: #333; border: 1px solid #e9ecef; min-height: 200px; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .heart-container { text-align: center; margin: 3rem 0; }
        .heart-btn { background: none; border: none; cursor: pointer; font-size: 2.5rem; color: #ccc; transition: all 0.2s; padding: 10px; }
        .heart-btn.active { color: #ff4757; transform: scale(1.1); }
        .heart-btn:hover { transform: scale(1.1); }
        .like-count { font-size: 1.2rem; font-weight: bold; color: #555; }
        .comment-section { margin-top: 4rem; border-top: 1px solid #eee; padding-top: 2rem; margin-bottom: 3rem; }
        .comment-section h3 { margin-bottom: 1.5rem; font-size: 1.3rem; color: #333; border-bottom: 2px solid #333; padding-bottom: 0.5rem; }
        .comment-form-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); border: 1px solid #e0e0e0; margin-bottom: 2rem; }
        .comment-list { list-style: none; padding: 0; }
        .comment-item { background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); border: 1px solid #e0e0e0; margin-bottom: 15px; }
        .comment-form { display: flex; gap: 10px; }
        .comment-input { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; transition: border-color 0.2s; }
        .comment-input:focus { outline: none; border-color: #333; }
        .comment-btn { padding: 0 25px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        .comment-btn:hover { background: #555; }
        .reply-form { margin-top: 10px; margin-left: 20px; display: none; }
        .reply-item { margin-left: 40px; background: #f9f9f9; border-radius: 8px; margin-top: 10px; padding: 10px; }
        .btn-sm { font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: white; border-radius: 4px; color: #666; cursor: pointer; margin-left: 10px; }
        .delete-btn { font-size: 12px; color: #dc3545; background: none; border: none; cursor: pointer; text-decoration: underline; margin-left: 5px; }
        .edit-form { margin-top: 10px; display: flex; gap: 10px; }
        .edit-btn { font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: white; border-radius: 4px; color: #0066cc; cursor: pointer; margin-left: 10px; }
        @media (max-width: 768px) { .comment-form-card { padding: 15px; } .comment-form { flex-direction: column; } .edit-form { flex-direction: column; } }
    </style>
</head>
<body>
<a th:href="@{/posts/list}">&larr; 一覧に戻る</a>
<h1 th:text="${post.title}">タイトル</h1>
<p class="muted">
    <span>投稿番号 #</span><span th:text="${post.id}">1</span> ·
    <span th:text="${post.author}">投稿者</span>
</p>
<pre th:text="${post.content}">投稿内容です。</pre>
<div class="heart-container">
    <button class="heart-btn" id="heartBtn" th:classappend="${isLiked} ? 'active' : ''" th:onclick="'toggleLike(' + ${post.id} + ')'">
        <i class="fa-solid fa-heart"></i>
    </button>
    <br>
    <span class="like-count" id="likeCount" th:text="${post.likeCount}">0</span>人がいいねしました
</div>

<div th:if="${isAuthor}" class="post-actions" style="margin: 1rem 0; text-align: right; border-top: 1px solid #eee; padding-top: 1rem;">
    <a th:href="@{/posts/{id}/edit(id=${post.id})}" class="btn" style="padding: 8px 15px; background: #fff; border: 1px solid #ddd; border-radius: 4px; color: #555; cursor: pointer; text-decoration: none;">修正</a>
    <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" style="display:inline;">
        <button type="submit" class="btn" style="padding: 8px 15px; background: #fff; border: 1px solid #dc3545; border-radius: 4px; color: #dc3545; cursor: pointer; margin-left: 5px;" onclick="return confirm('本当に削除しますか？')">削除</button>
    </form>
</div>

<div class="comment-section">
    <h3>コメント</h3>
    <div class="comment-form-card">
        <form class="comment-form" th:action="@{/posts/{postId}/comments(postId=${post.id})}" method="post">
            <input type="text" name="content" placeholder="コメントを入力..." class="comment-input" required style="flex: 1;" />
            <button type="submit" class="comment-btn">登録</button>
        </form>
    </div>
    <ul class="comment-list">
        <li th:each="comment : ${comments}">
            <div class="comment-item" th:id="'comment-' + ${comment.id}">
                <div>
                    <strong th:text="${comment.author}">投稿者</strong>:
                    <span class="comment-text" th:id="'comment-text-' + ${comment.id}" th:text="${comment.content}">内容</span>
                    <button type="button" class="btn-sm" th:onclick="'toggleReplyForm(' + ${comment.id} + ')'">返信</button>
                    <button th:if="${currentUserNickname != null and currentUserNickname == comment.author}" 
                            type="button" 
                            class="edit-btn" 
                            th:onclick="'toggleEditForm(' + ${comment.id} + ')'">修正</button>
                    <form th:if="${currentUserNickname != null and currentUserNickname == comment.author}" 
                          th:action="@{/comments/{id}/delete(id=${comment.id})}" 
                          method="post" 
                          style="display:inline;">
                        <input type="hidden" name="postId" th:value="${post.id}" />
                        <button type="submit" class="delete-btn" onclick="return confirm('削除しますか?')">削除</button>
                    </form>
                </div>
                <!-- 수정 폼 (hidden) -->
                <div th:id="'editForm-' + ${comment.id}" class="edit-form" style="display:none;">
                    <input type="text" 
                           th:id="'editInput-' + ${comment.id}" 
                           th:value="${comment.content}" 
                           class="comment-input" 
                           style="flex: 1;">
                    <button type="button" 
                            class="comment-btn" 
                            style="padding: 0 15px;" 
                            th:onclick="'saveEdit(' + ${comment.id} + ')'">保存</button>
                    <button type="button" 
                            class="btn-sm" 
                            th:onclick="'cancelEdit(' + ${comment.id} + ')'">キャンセル</button>
                </div>
            </div>
            <div th:each="reply : ${comment.children}" class="comment-item reply-item" th:id="'comment-' + ${reply.id}">
                <div>
                    ↓ <strong th:text="${reply.author}">投稿者</strong>:
                    <span class="comment-text" th:id="'comment-text-' + ${reply.id}" th:text="${reply.content}">返信内容</span>
                    <button th:if="${currentUserNickname != null and currentUserNickname == reply.author}" 
                            type="button" 
                            class="edit-btn" 
                            th:onclick="'toggleEditForm(' + ${reply.id} + ')'">修正</button>
                    <form th:if="${currentUserNickname != null and currentUserNickname == reply.author}" 
                          th:action="@{/comments/{id}/delete(id=${reply.id})}" 
                          method="post" 
                          style="display:inline;">
                        <input type="hidden" name="postId" th:value="${post.id}" />
                        <button type="submit" class="delete-btn" onclick="return confirm('削除しますか?')">削除</button>
                    </form>
                </div>
                <!-- 대댓글 수정 폼 -->
                <div th:id="'editForm-' + ${reply.id}" class="edit-form" style="display:none;">
                    <input type="text" 
                           th:id="'editInput-' + ${reply.id}" 
                           th:value="${reply.content}" 
                           class="comment-input" 
                           style="flex: 1;">
                    <button type="button" 
                            class="comment-btn" 
                            style="padding: 0 15px;" 
                            th:onclick="'saveEdit(' + ${reply.id} + ')'">保存</button>
                    <button type="button" 
                            class="btn-sm" 
                            th:onclick="'cancelEdit(' + ${reply.id} + ')'">キャンセル</button>
                </div>
            </div>
            <form th:id="'replyForm-' + ${comment.id}" class="comment-form reply-form" th:action="@{/posts/{postId}/comments(postId=${post.id})}" method="post">
                <input type="hidden" name="parentId" th:value="${comment.id}" />
                <input type="text" name="content" placeholder="返信内容を入力..." class="comment-input" required style="flex: 1;" />
                <button type="submit" class="comment-btn">登録</button>
            </form>
        </li>
        <li th:if="${#lists.isEmpty(comments)}" style="color: #999; text-align: center; margin-top: 2rem;">
            まだコメントがありません。
        </li>
    </ul>
</div>
<script>
    function toggleLike(postId) {
        fetch('/posts/' + postId + '/like', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        }).then(response => {
            if (response.status === 401) {
                alert("ログインが必要です！");
                location.href =  "/users/login";
                return;
            }
            return response.json();
        }).then(data => {
            if (data) {
                document.getElementById('likeCount').innerText = data.likeCount;
                const btn = document.getElementById('heartBtn');
                if (data.liked) btn.classList.add('active');
                else btn.classList.remove('active');
            }
        });
    }
    function toggleReplyForm(commentId) {
        const form = document.getElementById('replyForm-' + commentId);
        if (form.style.display === 'none' || form.style.display === '') {
            form.style.display = 'flex';
        } else {
            form.style.display = 'none';
        }
    }
    
    // 수정 폼 토글
    function toggleEditForm(commentId) {
        const form = document.getElementById('editForm-' + commentId);
        if (form.style.display === 'none' || form.style.display === '') {
            form.style.display = 'flex';
        } else {
            form.style.display = 'none';
        }
    }
    
    // 댓글 수정 저장
    function saveEdit(commentId) {
        const newContent = document.getElementById('editInput-' + commentId).value;
        
        if (!newContent.trim()) {
            alert('内容を入力してください');
            return;
        }
        
        fetch('/api/comments/' + commentId, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content: newContent})
        }).then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('修正に失敗しました');
            }
        }).then(data => {
            // DOM 업데이트 (페이지 새로고침 없이)
            document.getElementById('comment-text-' + commentId).textContent = newContent;
            document.getElementById('editForm-' + commentId).style.display = 'none';
        }).catch(error => {
            alert(error.message);
        });
    }
    
    // 수정 취소
    function cancelEdit(commentId) {
        document.getElementById('editForm-' + commentId).style.display = 'none';
    }
</script>
</body>
</html>

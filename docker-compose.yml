version: '3.8'

services:
  # ==========================================
  # Nginx (리버스 프록시 & 웹 서버)
  # ==========================================
  nginx:
    image: nginx:alpine
    container_name: blog-nginx
    ports:
      - "80:80"      # HTTP 포트
    volumes:
      # Nginx 설정 파일 마운트
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - app
    networks:
      - blog-network
    restart: unless-stopped

  # ==========================================
  # Spring Boot 애플리케이션
  # ==========================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: blog-app
    environment:
      # 환경변수로 설정 주입
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://db:3306/blog?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8&allowPublicKeyRetrieval=true}
      - SPRING_DATASOURCE_USERNAME=${DB_USERNAME:-bloguser}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD:-blogpassword}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
    depends_on:
      db:
        condition: service_healthy
    networks:
      - blog-network
    restart: unless-stopped

  # ==========================================
  # MySQL 데이터베이스
  # ==========================================
  db:
    image: mysql:8.0
    container_name: blog-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-rootpassword}
      - MYSQL_DATABASE=blog
      - MYSQL_USER=${DB_USERNAME:-bloguser}
      - MYSQL_PASSWORD=${DB_PASSWORD:-blogpassword}
    volumes:
      # 데이터 영구 저장 (컨테이너 삭제해도 데이터 유지)
      - mysql-data:/var/lib/mysql
      # 초기 스키마 실행
      - ./src/main/resources/schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro
    ports:
      - "3307:3306"  # 로컬 포트를 3307로 변경 (로컬 MySQL과 충돌 방지)
    healthcheck:
      # DB가 준비될 때까지 대기
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - blog-network
    restart: unless-stopped

# ==========================================
# 네트워크 정의
# ==========================================
networks:
  blog-network:
    driver: bridge

# ==========================================
# 볼륨 정의 (데이터 영구 저장)
# ==========================================
volumes:
  mysql-data:
